name: CI
on:
  - push
  - pull_request
  - workflow_dispatch

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    # PREVENT HANGS: Limit threading for scientific libraries in CI
    env:
      OMP_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      OPENBLAS_NUM_THREADS: "1"
      VECLIB_MAXIMUM_THREADS: "1"
      NUMEXPR_NUM_THREADS: "1"

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment.yml
          cache-environment: true
          create-args: >-
            python=${{ matrix.python-version }}

      - name: Verify Environment
        shell: bash -l {0}
        run: |
          micromamba info
          micromamba list

      - name: Build & compile HPB (Linux)
        if: runner.os == 'Linux'
        shell: bash -l {0}
        run: |
          pip install -e .
          python setup.py build_ext --inplace --force
          
          # Verification
          ls -lh prody/proteins/hpb.so || { echo "hpb.so missing"; exit 1; }
          ldd prody/proteins/hpb.so || { echo "linking failed"; exit 1; }

      - name: Build & compile HPB (macOS)
        if: runner.os == 'macOS'
        shell: bash -l {0}
        run: |
          export CFLAGS="${CFLAGS} -D__NO_FLOAT16"
          export CPPFLAGS="${CPPFLAGS} -D__NO_FLOAT16"

          pushd prody/proteins/hpbmodule

          gfortran -O3 -fPIC -c reg_tet.f || exit 1
          
          PYINC=$(python -c "import sysconfig; print(sysconfig.get_path('include'))")
          PYLIBDIR=$(python -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))")
          export LIBRARY_PATH="$CONDA_PREFIX/lib:$PYLIBDIR:$LIBRARY_PATH"

          g++ -O3 -g -fPIC -I"${PYINC}" -c hpbmodule.cpp -o hpbmodule.o || exit 1

          g++ -dynamiclib -undefined dynamic_lookup \
              -o hpb.so hpbmodule.o reg_tet.o \
              -L"${PYLIBDIR}" -L"$CONDA_PREFIX/lib" -lgfortran || exit 1
          
          cp hpb.so ../
          popd
          
          pip install -e .
          python setup.py build_ext --inplace --force

      # --- DEBUGGING STEPS START HERE ---
      
      # 1. Check if the module can even be imported (Hangs here = Bad compilation/linking)
      - name: Debug Imports
        shell: bash -l {0}
        timeout-minutes: 2
        run: |
          echo "Checking dependencies..."
          python -c "import numpy; print('Numpy:', numpy.__version__)"
          python -c "import openmm; print('OpenMM:', openmm.__version__)"
          
          echo "Checking ProDy import..."
          python -c "import prody; print('ProDy:', prody.__version__)"
          
          echo "Checking Extension import..."
          # This verifies if the .so can be loaded without segfaulting
          python -c "from prody.proteins import hpb; print('HPB Extension loaded successfully')"

      # 2. Check if pytest can collect tests (Hangs here = Bad module-level code)
      - name: Debug Test Collection
        shell: bash -l {0}
        timeout-minutes: 2
        run: |
          pytest --collect-only -v

      # 3. Run actual tests
      - name: Run tests
        shell: bash -l {0}
        timeout-minutes: 10
        run: |
          pip install pytest-timeout
          # -X faulthandler: dumps C-level traceback if python crashes/deadlocks
          python -X faulthandler -m pytest -v -s --timeout=300
