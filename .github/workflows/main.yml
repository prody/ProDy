name: CI
on:
  - push
  - pull_request
  - workflow_dispatch

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          micromamba-version: "latest"
          environment-name: test
          create-args: |
            python=${{ matrix.python-version }}
          init-shell: bash
          cache-environment: true
          cache-downloads: true

      - name: Create environment.yml
        run: |
          cat > environment.yml <<EOF
          name: test
          channels:
            - conda-forge
            - bioconda
          dependencies:
            - python=${{ matrix.python-version }}
            - compilers
            - gfortran
            - numpy
            - pyparsing<=3.1.1
            - scipy
            - nose
            - pytest
            - requests
            - pdbfixer
            - mdtraj
            - openmm
            - clustalw
            - pip
            - pip:
                - mmtf-python
                - scikit-learn
          EOF

      - name: Update environment
        shell: bash
        run: |
          micromamba env update -n test -f environment.yml

      - name: Build & compile HPB (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          micromamba run -n test pip install -e .
          micromamba run -n test python setup.py build_ext --inplace --force

          ls -lh prody/proteins/hpb.so
          file prody/proteins/hpb.so
          ldd prody/proteins/hpb.so

      - name: Build & compile HPB (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          export CFLAGS="${CFLAGS} -D__NO_FLOAT16"
          export CPPFLAGS="${CPPFLAGS} -D__NO_FLOAT16"

          pushd prody/proteins/hpbmodule

          # Fortran compile inside the env
          micromamba run -n test gfortran -O3 -fPIC -c reg_tet.f

          # Python include/lib dirs
          PYINC=$(micromamba run -n test python -c "import sysconfig; print(sysconfig.get_path('include'))")
          PYLIBDIR=$(micromamba run -n test python -c "import sysconfig; print(sysconfig.get_config_var('LIBDIR'))")

          # C++ compile inside the env
          micromamba run -n test g++ -O3 -fPIC -I"${PYINC}" -c hpbmodule.cpp -o hpbmodule.o

          # Link inside the env
          micromamba run -n test g++ -dynamiclib \
              -undefined dynamic_lookup \
              -o hpb.so hpbmodule.o reg_tet.o \
              -L"${PYLIBDIR}" -L"$CONDA_PREFIX/lib" -lgfortran

          ls -lh hpb.so
          otool -L hpb.so

          cp hpb.so ../
          popd

          micromamba run -n test pip install -e .
          micromamba run -n test python setup.py build_ext --inplace --force

      - name: Run tests
        shell: bash
        run: |
          micromamba run -n test pytest -q

