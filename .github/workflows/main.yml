name: CI

on:
  push:
  pull_request:

jobs:
  test:
    name: Test (${{ matrix.os }}, py${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      # ------- Install compilers (macOS needs gfortran) -------
      - name: Install build tools (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install gfortran || true

      - name: Install build tools (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gfortran

      # ------- Setup micromamba -------
      - uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: test
          create-args: >-
            python=${{ matrix.python-version }}
          cache-environment: true
          cache-environment-key: ${{ runner.os }}-${{ matrix.python-version }}

      # ------- Install package dependencies -------
      - name: Install package dependencies
        shell: bash
        run: |
          eval "$(micromamba shell hook -s bash)"
          micromamba activate test

          micromamba install -y \
            numpy scipy matplotlib biopython \
            pytest pip setuptools wheel

          # If you need additional deps, add them here
          # micromamba install -y <packages>

          pip install -e .

      # ------- Run tests -------
      - name: Run tests
        shell: bash
        run: |
          eval "$(micromamba shell hook -s bash)"
          micromamba activate test

          pytest -q

